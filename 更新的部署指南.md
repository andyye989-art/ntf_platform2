# 数字文物NFT平台部署指南（更新版）

## 概述

本文档提供了数字文物NFT平台的完整部署指南，包括使用Miniconda管理Python虚拟环境、MySQL数据库配置、开发环境搭建、生产环境部署、配置管理和运维监控等内容。本版本已更新为支持最新的技术栈和部署方式。

## 系统要求

### 硬件要求

**开发环境：**
- CPU: 4核心以上
- 内存: 8GB以上
- 存储: 50GB以上可用空间
- 网络: 稳定的互联网连接

**生产环境：**
- CPU: 8核心以上
- 内存: 16GB以上
- 存储: 200GB以上SSD存储
- 网络: 高带宽、低延迟网络连接
- 负载均衡器支持

### 软件要求

**操作系统：**
- Ubuntu 20.04 LTS 或更高版本
- CentOS 8 或更高版本
- macOS 10.15 或更高版本（仅开发环境）

**运行时环境：**
- Node.js 18.x 或更高版本
- Python 3.11（通过Miniconda管理）
- MySQL 8.0 或更高版本
- Redis 6.x 或更高版本
- Nginx 1.18 或更高版本

## 开发环境搭建

### 1. 环境准备

```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git vim build-essential

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 验证Node.js安装
node --version
npm --version
```

### 2. Miniconda安装与配置

```bash
# 下载Miniconda安装脚本
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh

# 安装Miniconda
bash Miniconda3-latest-Linux-x86_64.sh -b -p ~/miniconda

# 初始化conda
~/miniconda/bin/conda init

# 重新加载shell配置
source ~/.bashrc

# 创建Python虚拟环境
conda create -n nft_backend python=3.11 -y

# 激活虚拟环境
conda activate nft_backend

# 验证Python版本
python --version
```

### 3. MySQL数据库安装与配置

```bash
# 安装MySQL服务器
sudo apt install -y mysql-server mysql-client

# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置MySQL
sudo mysql_secure_installation

# 登录MySQL并创建数据库
sudo mysql -u root -p

# 在MySQL命令行中执行以下命令
CREATE DATABASE nft_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'nft_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON nft_platform.* TO 'nft_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 4. Redis安装

```bash
# 安装Redis
sudo apt install -y redis-server

# 启动Redis服务
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 验证Redis安装
redis-cli ping
```

## 项目代码部署

### 1. 克隆项目代码

```bash
# 克隆项目仓库
git clone https://github.com/andyye989-art/nft-platform.git
cd nft-platform
```

### 2. 后端部署

```bash
# 进入后端目录
cd nft-platform-backend

# 激活Miniconda虚拟环境
conda activate nft_backend

# 安装Python依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
# 编辑.env文件，配置数据库连接等信息

# 创建数据库表
python -c "from src.main import app, db; app.app_context().push(); db.create_all()"

# 启动后端服务
chmod +x start.sh
./start.sh
```

### 3. 前端部署

```bash
# 进入前端目录
cd ../nft-platform-frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 启动开发服务器（开发环境）
npm run dev

# 或者使用生产服务器
npm run preview
```

### 4. 智能合约部署

```bash
# 进入智能合约目录
cd ../nft-platform-contracts

# 安装依赖
npm install

# 编译合约
npx hardhat compile

# 部署到测试网络
npx hardhat run scripts/deploy.js --network sepolia

# 部署到主网络（生产环境）
npx hardhat run scripts/deploy.js --network mainnet
```

## 环境变量配置

### 后端环境变量 (.env)

```bash
# 数据库配置
DATABASE_URL=mysql+pymysql://nft_user:your_secure_password@localhost:3306/nft_platform

# Flask配置
SECRET_KEY=your_very_secure_secret_key_here
DEBUG=False
FLASK_ENV=production

# CORS配置
CORS_ORIGINS=["http://localhost:3000", "https://yourdomain.com"]

# 区块链配置
WEB3_PROVIDER_URL=https://mainnet.infura.io/v3/your_infura_project_id
PRIVATE_KEY=your_private_key_for_contract_deployment

# IPFS配置
IPFS_API_URL=https://ipfs.infura.io:5001
IPFS_GATEWAY_URL=https://ipfs.io/ipfs/

# JWT配置
JWT_SECRET_KEY=your_jwt_secret_key
JWT_ACCESS_TOKEN_EXPIRES=3600

# 邮件配置
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USE_TLS=True
MAIL_USERNAME=your_email@gmail.com
MAIL_PASSWORD=your_app_password

# Redis配置
REDIS_URL=redis://localhost:6379/0
```

### 前端环境变量 (.env.local)

```bash
# API配置
NEXT_PUBLIC_API_BASE_URL=http://localhost:5000/api
NEXT_PUBLIC_WS_URL=ws://localhost:5000

# 区块链配置
NEXT_PUBLIC_CHAIN_ID=1
NEXT_PUBLIC_RPC_URL=https://mainnet.infura.io/v3/your_infura_project_id

# 合约地址
NEXT_PUBLIC_NFT_CONTRACT_ADDRESS=0x...
NEXT_PUBLIC_MARKETPLACE_CONTRACT_ADDRESS=0x...
NEXT_PUBLIC_FACTORY_CONTRACT_ADDRESS=0x...

# IPFS配置
NEXT_PUBLIC_IPFS_GATEWAY=https://ipfs.io/ipfs/

# 分析工具
NEXT_PUBLIC_GA_ID=your_google_analytics_id
```

## 生产环境部署

### 1. Nginx配置

```nginx
# /etc/nginx/sites-available/nft-platform
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;

    # 前端静态文件
    location / {
        root /var/www/nft-platform/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket支持
    location /socket.io/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 2. Systemd服务配置

**后端服务配置 (/etc/systemd/system/nft-backend.service):**

```ini
[Unit]
Description=NFT Platform Backend
After=network.target mysql.service redis.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/var/www/nft-platform/backend
Environment=PATH=/home/www-data/miniconda/envs/nft_backend/bin
ExecStart=/home/www-data/miniconda/envs/nft_backend/bin/python src/main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 3. 启动服务

```bash
# 启用并启动服务
sudo systemctl enable nft-backend
sudo systemctl start nft-backend

# 启用并启动Nginx
sudo systemctl enable nginx
sudo systemctl start nginx

# 检查服务状态
sudo systemctl status nft-backend
sudo systemctl status nginx
```

## Docker部署（可选）

### 1. 后端Dockerfile

```dockerfile
# nft-platform-backend/Dockerfile
FROM continuumio/miniconda3:latest

WORKDIR /app

# 复制环境文件
COPY environment.yml .
RUN conda env create -f environment.yml

# 激活环境
SHELL ["conda", "run", "-n", "nft_backend", "/bin/bash", "-c"]

# 复制应用代码
COPY . .

# 安装Python依赖
RUN conda run -n nft_backend pip install -r requirements.txt

# 暴露端口
EXPOSE 5000

# 启动应用
CMD ["conda", "run", "-n", "nft_backend", "python", "src/main.py"]
```

### 2. 前端Dockerfile

```dockerfile
# nft-platform-frontend/Dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制package文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建应用
RUN npm run build

# 暴露端口
EXPOSE 3000

# 启动应用
CMD ["npm", "start"]
```

### 3. Docker Compose配置

```yaml
# docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: nft_platform
      MYSQL_USER: nft_user
      MYSQL_PASSWORD: nft_password
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"

  backend:
    build: ./nft-platform-backend
    depends_on:
      - mysql
      - redis
    environment:
      - DATABASE_URL=mysql+pymysql://nft_user:nft_password@mysql:3306/nft_platform
      - REDIS_URL=redis://redis:6379/0
    ports:
      - "5000:5000"

  frontend:
    build: ./nft-platform-frontend
    depends_on:
      - backend
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://backend:5000/api
    ports:
      - "3000:3000"

  nginx:
    image: nginx:alpine
    depends_on:
      - frontend
      - backend
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"
      - "443:443"

volumes:
  mysql_data:
```

## 监控与日志

### 1. 日志配置

```python
# 后端日志配置
import logging
from logging.handlers import RotatingFileHandler

if not app.debug:
    file_handler = RotatingFileHandler('logs/nft-platform.log', maxBytes=10240, backupCount=10)
    file_handler.setFormatter(logging.Formatter(
        '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'
    ))
    file_handler.setLevel(logging.INFO)
    app.logger.addHandler(file_handler)
    app.logger.setLevel(logging.INFO)
    app.logger.info('NFT Platform startup')
```

### 2. 性能监控

```bash
# 安装监控工具
sudo apt install -y htop iotop nethogs

# 监控系统资源
htop

# 监控磁盘I/O
sudo iotop

# 监控网络使用
sudo nethogs
```

## 安全配置

### 1. 防火墙配置

```bash
# 启用UFW防火墙
sudo ufw enable

# 允许SSH
sudo ufw allow ssh

# 允许HTTP和HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 允许MySQL（仅本地）
sudo ufw allow from 127.0.0.1 to any port 3306

# 查看防火墙状态
sudo ufw status
```

### 2. SSL证书配置

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 设置自动续期
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

## 备份与恢复

### 1. 数据库备份

```bash
# 创建备份脚本
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/nft-platform"
DB_NAME="nft_platform"
DB_USER="nft_user"
DB_PASS="your_password"

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/db_backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/db_backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +7 -delete

echo "Database backup completed: db_backup_$DATE.sql.gz"
```

### 2. 文件备份

```bash
# 备份应用文件
rsync -av --delete /var/www/nft-platform/ /var/backups/nft-platform/app_backup/

# 备份用户上传的文件
rsync -av --delete /var/www/nft-platform/uploads/ /var/backups/nft-platform/uploads_backup/
```

## 故障排除

### 1. 常见问题

**问题：后端服务无法启动**
```bash
# 检查日志
sudo journalctl -u nft-backend -f

# 检查端口占用
sudo netstat -tlnp | grep :5000

# 检查Python环境
conda activate nft_backend
python --version
pip list
```

**问题：数据库连接失败**
```bash
# 检查MySQL服务状态
sudo systemctl status mysql

# 检查数据库连接
mysql -u nft_user -p nft_platform

# 检查防火墙设置
sudo ufw status
```

**问题：前端页面无法加载**
```bash
# 检查Nginx配置
sudo nginx -t

# 检查Nginx日志
sudo tail -f /var/log/nginx/error.log

# 检查前端构建
cd /var/www/nft-platform/frontend
npm run build
```

### 2. 性能优化

**数据库优化：**
```sql
-- 添加索引
CREATE INDEX idx_nft_creator ON nft_items(creator_id);
CREATE INDEX idx_nft_owner ON nft_items(current_owner_id);
CREATE INDEX idx_transaction_date ON transactions(created_at);

-- 优化查询
EXPLAIN SELECT * FROM nft_items WHERE creator_id = 1;
```

**缓存配置：**
```python
# Redis缓存配置
from flask_caching import Cache

cache = Cache(app, config={
    'CACHE_TYPE': 'redis',
    'CACHE_REDIS_URL': 'redis://localhost:6379/0'
})

@cache.memoize(timeout=300)
def get_popular_nfts():
    return NFTItem.query.filter_by(is_featured=True).all()
```

## 更新与维护

### 1. 应用更新

```bash
# 备份当前版本
cp -r /var/www/nft-platform /var/backups/nft-platform_$(date +%Y%m%d)

# 拉取最新代码
cd /var/www/nft-platform
git pull origin main

# 更新后端依赖
cd nft-platform-backend
conda activate nft_backend
pip install -r requirements.txt

# 更新前端依赖
cd ../nft-platform-frontend
npm install
npm run build

# 重启服务
sudo systemctl restart nft-backend
sudo systemctl reload nginx
```

### 2. 数据库迁移

```bash
# 运行数据库迁移
cd /var/www/nft-platform/nft-platform-backend
conda activate nft_backend
python -c "from src.main import app, db; app.app_context().push(); db.create_all()"
```

## 结论

本部署指南提供了数字文物NFT平台的完整部署流程，包括使用Miniconda管理Python环境和MySQL数据库配置。通过遵循本指南，您可以成功部署一个稳定、安全、高性能的NFT平台。

在部署过程中，请特别注意安全配置、性能优化和监控设置，确保平台能够稳定运行并提供良好的用户体验。定期进行备份和更新，保持系统的安全性和功能的先进性。

