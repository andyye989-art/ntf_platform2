# 数字文物NFT平台部署指南

## 概述

本文档提供了数字文物NFT平台的完整部署指南，包括开发环境搭建、生产环境部署、配置管理和运维监控等内容。

## 系统要求

### 硬件要求

**开发环境：**
- CPU: 4核心以上
- 内存: 8GB以上
- 存储: 50GB以上可用空间
- 网络: 稳定的互联网连接

**生产环境：**
- CPU: 8核心以上
- 内存: 16GB以上
- 存储: 200GB以上SSD存储
- 网络: 高带宽、低延迟网络连接
- 负载均衡器支持

### 软件要求

**操作系统：**
- Ubuntu 20.04 LTS 或更高版本
- CentOS 8 或更高版本
- macOS 10.15 或更高版本（仅开发环境）

**运行时环境：**
- Node.js 18.x 或更高版本
- Python 3.9 或更高版本
- PostgreSQL 13 或更高版本
- Redis 6.x 或更高版本
- Nginx 1.18 或更高版本

## 开发环境搭建

### 1. 环境准备

```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git vim build-essential

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 安装Python和pip
sudo apt install -y python3 python3-pip python3-venv

# 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 安装Redis
sudo apt install -y redis-server
```

### 2. 克隆项目代码

```bash
# 克隆项目仓库
git clone https://github.com/your-org/nft-platform.git
cd nft-platform

# 查看项目结构
ls -la
```

### 3. 后端环境搭建

```bash
# 进入后端目录
cd nft-platform-backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
vim .env
```

**环境变量配置示例：**

```bash
# Flask配置
FLASK_ENV=development
SECRET_KEY=your-secret-key-here
DEBUG=True

# 数据库配置
DATABASE_URL=postgresql://username:password@localhost:5432/nft_platform

# JWT配置
JWT_SECRET_KEY=your-jwt-secret-key

# 区块链配置
WEB3_PROVIDER_URL=https://mainnet.infura.io/v3/your_project_id
POLYGON_PROVIDER_URL=https://polygon-mainnet.infura.io/v3/your_project_id

# IPFS配置
IPFS_API_URL=https://ipfs.infura.io:5001
IPFS_PROJECT_ID=your_project_id
IPFS_PROJECT_SECRET=your_project_secret

# 邮件配置
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=your_email@gmail.com
MAIL_PASSWORD=your_app_password
```

### 4. 数据库初始化

```bash
# 创建数据库
sudo -u postgres createdb nft_platform

# 运行数据库迁移
python src/manage.py db init
python src/manage.py db migrate
python src/manage.py db upgrade
```

### 5. 前端环境搭建

```bash
# 进入前端目录
cd ../nft-platform-frontend

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env.local
vim .env.local
```

**前端环境变量配置：**

```bash
VITE_API_BASE_URL=http://localhost:5000
VITE_IPFS_GATEWAY=https://ipfs.io/ipfs/
VITE_CHAIN_ID=1
VITE_CHAIN_NAME=Ethereum Mainnet
```

### 6. 启动开发服务器

```bash
# 启动后端服务器
cd nft-platform-backend
source venv/bin/activate
python src/main.py

# 启动前端开发服务器（新终端）
cd nft-platform-frontend
npm run dev
```

## 生产环境部署

### 1. 服务器准备

```bash
# 创建应用用户
sudo useradd -m -s /bin/bash nftapp
sudo usermod -aG sudo nftapp

# 切换到应用用户
sudo su - nftapp

# 创建应用目录
mkdir -p /home/nftapp/apps
cd /home/nftapp/apps
```

### 2. 数据库部署

```bash
# 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 配置PostgreSQL
sudo -u postgres psql
```

```sql
-- 创建数据库和用户
CREATE DATABASE nft_platform_prod;
CREATE USER nftapp WITH PASSWORD 'secure_password_here';
GRANT ALL PRIVILEGES ON DATABASE nft_platform_prod TO nftapp;
\q
```

```bash
# 配置PostgreSQL连接
sudo vim /etc/postgresql/13/main/postgresql.conf
# 修改 listen_addresses = 'localhost'

sudo vim /etc/postgresql/13/main/pg_hba.conf
# 添加 local   nft_platform_prod   nftapp   md5

# 重启PostgreSQL
sudo systemctl restart postgresql
```

### 3. Redis部署

```bash
# 安装Redis
sudo apt install -y redis-server

# 配置Redis
sudo vim /etc/redis/redis.conf
# 修改以下配置：
# bind 127.0.0.1
# requirepass your_redis_password
# maxmemory 1gb
# maxmemory-policy allkeys-lru

# 重启Redis
sudo systemctl restart redis-server
sudo systemctl enable redis-server
```

### 4. 应用部署

```bash
# 克隆代码
git clone https://github.com/your-org/nft-platform.git
cd nft-platform

# 部署后端
cd nft-platform-backend
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 配置生产环境变量
cp .env.example .env.prod
vim .env.prod
```

**生产环境配置：**

```bash
FLASK_ENV=production
SECRET_KEY=very-secure-secret-key-here
DEBUG=False

DATABASE_URL=postgresql://nftapp:secure_password_here@localhost:5432/nft_platform_prod
REDIS_URL=redis://:your_redis_password@localhost:6379/0

# 其他配置...
```

```bash
# 运行数据库迁移
export FLASK_APP=src/main.py
flask db upgrade

# 构建前端
cd ../nft-platform-frontend
npm install
npm run build
```

### 5. Nginx配置

```bash
# 安装Nginx
sudo apt install -y nginx

# 创建站点配置
sudo vim /etc/nginx/sites-available/nft-platform
```

```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 前端静态文件
    location / {
        root /home/nftapp/apps/nft-platform/nft-platform-frontend/dist;
        try_files $uri $uri/ /index.html;
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API代理
    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # 文件上传大小限制
    client_max_body_size 100M;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/nft-platform /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
sudo systemctl enable nginx
```

### 6. SSL证书配置

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 设置自动续期
sudo crontab -e
# 添加：0 12 * * * /usr/bin/certbot renew --quiet
```

### 7. 进程管理

```bash
# 安装Supervisor
sudo apt install -y supervisor

# 创建后端服务配置
sudo vim /etc/supervisor/conf.d/nft-backend.conf
```

```ini
[program:nft-backend]
command=/home/nftapp/apps/nft-platform/nft-platform-backend/venv/bin/python src/main.py
directory=/home/nftapp/apps/nft-platform/nft-platform-backend
user=nftapp
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/nft-backend.log
environment=FLASK_ENV=production
```

```bash
# 重新加载Supervisor配置
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start nft-backend

# 检查状态
sudo supervisorctl status
```

## 智能合约部署

### 1. 环境准备

```bash
# 安装Hardhat
cd nft-platform-contracts
npm install

# 配置网络
vim hardhat.config.js
```

```javascript
require("@nomiclabs/hardhat-waffle");
require("@nomiclabs/hardhat-etherscan");
require("dotenv").config();

module.exports = {
  solidity: "0.8.19",
  networks: {
    mainnet: {
      url: process.env.MAINNET_URL,
      accounts: [process.env.PRIVATE_KEY]
    },
    polygon: {
      url: process.env.POLYGON_URL,
      accounts: [process.env.PRIVATE_KEY]
    },
    goerli: {
      url: process.env.GOERLI_URL,
      accounts: [process.env.PRIVATE_KEY]
    }
  },
  etherscan: {
    apiKey: process.env.ETHERSCAN_API_KEY
  }
};
```

### 2. 合约部署

```bash
# 编译合约
npx hardhat compile

# 部署到测试网
npx hardhat run scripts/deploy.js --network goerli

# 部署到主网
npx hardhat run scripts/deploy.js --network mainnet

# 验证合约
npx hardhat verify --network mainnet DEPLOYED_CONTRACT_ADDRESS
```

### 3. 更新配置

```bash
# 更新后端配置
vim nft-platform-backend/.env.prod
```

```bash
ARTIFACT_FACTORY_ADDRESS=0x...
ARTIFACT_MARKETPLACE_ADDRESS=0x...
```

## 监控和日志

### 1. 日志配置

```bash
# 配置日志轮转
sudo vim /etc/logrotate.d/nft-platform
```

```
/var/log/supervisor/nft-backend.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 nftapp nftapp
    postrotate
        supervisorctl restart nft-backend
    endscript
}
```

### 2. 监控脚本

```bash
# 创建健康检查脚本
vim /home/nftapp/scripts/health_check.sh
```

```bash
#!/bin/bash

# 检查后端API
if curl -f http://localhost:5000/api/health > /dev/null 2>&1; then
    echo "Backend API is healthy"
else
    echo "Backend API is down"
    # 发送告警
    supervisorctl restart nft-backend
fi

# 检查数据库连接
if pg_isready -h localhost -p 5432 > /dev/null 2>&1; then
    echo "Database is healthy"
else
    echo "Database is down"
    # 发送告警
fi

# 检查Redis
if redis-cli ping > /dev/null 2>&1; then
    echo "Redis is healthy"
else
    echo "Redis is down"
    # 发送告警
fi
```

```bash
# 设置定时检查
chmod +x /home/nftapp/scripts/health_check.sh
crontab -e
# 添加：*/5 * * * * /home/nftapp/scripts/health_check.sh
```

## 备份和恢复

### 1. 数据库备份

```bash
# 创建备份脚本
vim /home/nftapp/scripts/backup_db.sh
```

```bash
#!/bin/bash

BACKUP_DIR="/home/nftapp/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="nft_platform_prod"

mkdir -p $BACKUP_DIR

# 创建数据库备份
pg_dump -h localhost -U nftapp $DB_NAME | gzip > $BACKUP_DIR/db_backup_$DATE.sql.gz

# 保留最近30天的备份
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +30 -delete

echo "Database backup completed: db_backup_$DATE.sql.gz"
```

```bash
# 设置自动备份
chmod +x /home/nftapp/scripts/backup_db.sh
crontab -e
# 添加：0 2 * * * /home/nftapp/scripts/backup_db.sh
```

### 2. 文件备份

```bash
# 备份上传的文件
rsync -av /home/nftapp/apps/nft-platform/uploads/ /home/nftapp/backups/uploads/

# 备份配置文件
cp /home/nftapp/apps/nft-platform/nft-platform-backend/.env.prod /home/nftapp/backups/config/
```

## 性能优化

### 1. 数据库优化

```sql
-- 创建索引
CREATE INDEX idx_nft_items_creator_id ON nft_items(creator_id);
CREATE INDEX idx_nft_items_owner_id ON nft_items(owner_id);
CREATE INDEX idx_nft_items_created_at ON nft_items(created_at);
CREATE INDEX idx_transactions_nft_item_id ON transactions(nft_item_id);

-- 配置PostgreSQL
-- 在 postgresql.conf 中：
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
```

### 2. Redis缓存

```python
# 在后端代码中添加缓存
from flask_caching import Cache

cache = Cache(app, config={'CACHE_TYPE': 'redis'})

@cache.memoize(timeout=300)
def get_popular_nfts():
    # 缓存热门NFT列表
    pass
```

### 3. CDN配置

```bash
# 配置Nginx缓存
vim /etc/nginx/sites-available/nft-platform
```

```nginx
# 添加缓存配置
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary Accept-Encoding;
}
```

## 安全配置

### 1. 防火墙设置

```bash
# 配置UFW防火墙
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
```

### 2. 安全加固

```bash
# 禁用root登录
sudo vim /etc/ssh/sshd_config
# 设置：PermitRootLogin no

# 配置fail2ban
sudo apt install -y fail2ban
sudo vim /etc/fail2ban/jail.local
```

```ini
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3

[sshd]
enabled = true

[nginx-http-auth]
enabled = true
```

### 3. 定期安全更新

```bash
# 创建自动更新脚本
vim /home/nftapp/scripts/security_update.sh
```

```bash
#!/bin/bash
sudo apt update
sudo apt upgrade -y
sudo apt autoremove -y
```

## 故障排除

### 1. 常见问题

**后端服务无法启动：**
```bash
# 检查日志
sudo supervisorctl tail -f nft-backend

# 检查端口占用
sudo netstat -tlnp | grep :5000

# 检查环境变量
source venv/bin/activate
python -c "import os; print(os.environ.get('DATABASE_URL'))"
```

**数据库连接失败：**
```bash
# 检查PostgreSQL状态
sudo systemctl status postgresql

# 测试连接
psql -h localhost -U nftapp -d nft_platform_prod

# 检查配置
sudo vim /etc/postgresql/13/main/pg_hba.conf
```

**前端页面无法加载：**
```bash
# 检查Nginx状态
sudo systemctl status nginx

# 检查配置
sudo nginx -t

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

### 2. 性能问题

**数据库查询慢：**
```sql
-- 查看慢查询
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;

-- 分析查询计划
EXPLAIN ANALYZE SELECT * FROM nft_items WHERE creator_id = 1;
```

**内存使用过高：**
```bash
# 检查内存使用
free -h
top -p $(pgrep -f "python src/main.py")

# 检查Redis内存
redis-cli info memory
```

## 更新和维护

### 1. 应用更新

```bash
# 创建更新脚本
vim /home/nftapp/scripts/update_app.sh
```

```bash
#!/bin/bash

cd /home/nftapp/apps/nft-platform

# 备份当前版本
git stash
git checkout main
git pull origin main

# 更新后端
cd nft-platform-backend
source venv/bin/activate
pip install -r requirements.txt
flask db upgrade

# 更新前端
cd ../nft-platform-frontend
npm install
npm run build

# 重启服务
sudo supervisorctl restart nft-backend
sudo systemctl reload nginx

echo "Application updated successfully"
```

### 2. 维护计划

```bash
# 每日维护任务
0 2 * * * /home/nftapp/scripts/backup_db.sh
0 3 * * * /home/nftapp/scripts/cleanup_logs.sh

# 每周维护任务
0 4 * * 0 /home/nftapp/scripts/security_update.sh

# 每月维护任务
0 5 1 * * /home/nftapp/scripts/full_backup.sh
```

## 总结

本部署指南涵盖了数字文物NFT平台从开发环境搭建到生产环境部署的完整流程。通过遵循本指南，您可以成功部署一个稳定、安全、高性能的NFT平台。

关键要点：
1. 确保所有依赖项正确安装和配置
2. 使用适当的安全措施保护生产环境
3. 实施完善的监控和备份策略
4. 定期进行维护和更新
5. 建立故障排除和应急响应流程

如有问题，请参考故障排除部分或联系技术支持团队。

