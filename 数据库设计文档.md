# 数字文物NFT平台数据库设计文档

## 1. 数据库设计概述

本数字文物NFT平台的数据库设计旨在支持文物数字化、NFT铸造、链上交易、虚拟博物馆展示和文化内容管理等核心功能。数据库设计需要考虑以下关键因素：

*   **数据一致性**：确保链上数据与链下数据的一致性。
*   **性能优化**：支持高并发的查询和交易操作。
*   **扩展性**：能够随着用户和数据量的增长而扩展。
*   **安全性**：保护用户隐私和敏感数据。

## 2. 核心数据表设计

### 2.1 用户管理相关表

#### 2.1.1 用户表 (users)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 用户唯一标识 |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名 |
| email | VARCHAR(100) | UNIQUE, NOT NULL | 邮箱地址 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希值 |
| wallet_address | VARCHAR(42) | UNIQUE | 钱包地址 |
| profile_image | TEXT | | 头像图片URL |
| bio | TEXT | | 个人简介 |
| is_verified | BOOLEAN | DEFAULT FALSE | 是否已验证 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 2.1.2 用户钱包表 (user_wallets)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 钱包记录唯一标识 |
| user_id | BIGINT | FOREIGN KEY REFERENCES users(id) | 用户ID |
| wallet_address | VARCHAR(42) | NOT NULL | 钱包地址 |
| wallet_type | VARCHAR(20) | NOT NULL | 钱包类型（MetaMask, WalletConnect等） |
| is_primary | BOOLEAN | DEFAULT FALSE | 是否为主钱包 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 2.2 NFT相关表

#### 2.2.1 NFT集合表 (nft_collections)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 集合唯一标识 |
| creator_id | BIGINT | FOREIGN KEY REFERENCES users(id) | 创建者ID |
| contract_address | VARCHAR(42) | UNIQUE, NOT NULL | 智能合约地址 |
| name | VARCHAR(100) | NOT NULL | 集合名称 |
| symbol | VARCHAR(10) | NOT NULL | 集合符号 |
| description | TEXT | | 集合描述 |
| cover_image | TEXT | | 封面图片URL |
| banner_image | TEXT | | 横幅图片URL |
| royalty_percentage | DECIMAL(5,2) | DEFAULT 0.00 | 版税百分比 |
| total_supply | INT | DEFAULT 0 | 总供应量 |
| floor_price | DECIMAL(20,8) | | 地板价 |
| volume_traded | DECIMAL(20,8) | DEFAULT 0.00 | 交易总量 |
| is_verified | BOOLEAN | DEFAULT FALSE | 是否已验证 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 2.2.2 NFT藏品表 (nft_items)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 藏品唯一标识 |
| collection_id | BIGINT | FOREIGN KEY REFERENCES nft_collections(id) | 所属集合ID |
| token_id | VARCHAR(100) | NOT NULL | 链上Token ID |
| creator_id | BIGINT | FOREIGN KEY REFERENCES users(id) | 创建者ID |
| current_owner_id | BIGINT | FOREIGN KEY REFERENCES users(id) | 当前拥有者ID |
| name | VARCHAR(200) | NOT NULL | 藏品名称 |
| description | TEXT | | 藏品描述 |
| image_url | TEXT | NOT NULL | 主图片URL |
| animation_url | TEXT | | 动画/视频URL |
| model_3d_url | TEXT | | 3D模型URL |
| metadata_uri | TEXT | NOT NULL | 元数据URI |
| metadata_hash | VARCHAR(64) | | 元数据哈希值 |
| rarity_rank | INT | | 稀有度排名 |
| rarity_score | DECIMAL(10,4) | | 稀有度分数 |
| is_minted | BOOLEAN | DEFAULT FALSE | 是否已铸造 |
| mint_transaction_hash | VARCHAR(66) | | 铸造交易哈希 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 2.2.3 NFT属性表 (nft_attributes)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 属性唯一标识 |
| nft_item_id | BIGINT | FOREIGN KEY REFERENCES nft_items(id) | NFT藏品ID |
| trait_type | VARCHAR(100) | NOT NULL | 属性类型 |
| value | VARCHAR(200) | NOT NULL | 属性值 |
| display_type | VARCHAR(50) | | 显示类型（string, number, date等） |
| max_value | DECIMAL(20,8) | | 最大值（用于数值类型） |
| rarity_percentage | DECIMAL(5,2) | | 稀有度百分比 |

### 2.3 文化内容管理相关表

#### 2.3.1 文物信息表 (artifact_info)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 文物信息唯一标识 |
| nft_item_id | BIGINT | FOREIGN KEY REFERENCES nft_items(id) | 关联的NFT藏品ID |
| artifact_name | VARCHAR(200) | NOT NULL | 文物名称 |
| origin_location | VARCHAR(200) | | 文物来源地 |
| historical_period | VARCHAR(100) | | 历史时期 |
| cultural_significance | TEXT | | 文化意义 |
| historical_story | TEXT | | 历史故事 |
| material | VARCHAR(100) | | 材质 |
| dimensions | VARCHAR(100) | | 尺寸 |
| weight | VARCHAR(50) | | 重量 |
| discovery_date | DATE | | 发现日期 |
| discovery_location | VARCHAR(200) | | 发现地点 |
| current_location | VARCHAR(200) | | 当前位置 |
| conservation_status | VARCHAR(100) | | 保存状态 |
| created_by | BIGINT | FOREIGN KEY REFERENCES users(id) | 创建者ID |
| updated_by | BIGINT | FOREIGN KEY REFERENCES users(id) | 最后更新者ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 2.3.2 文物图片表 (artifact_images)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 图片唯一标识 |
| artifact_info_id | BIGINT | FOREIGN KEY REFERENCES artifact_info(id) | 文物信息ID |
| image_url | TEXT | NOT NULL | 图片URL |
| image_type | VARCHAR(50) | NOT NULL | 图片类型（正面、背面、细节等） |
| description | TEXT | | 图片描述 |
| sort_order | INT | DEFAULT 0 | 排序顺序 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 2.4 交易相关表

#### 2.4.1 交易记录表 (transactions)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 交易唯一标识 |
| nft_item_id | BIGINT | FOREIGN KEY REFERENCES nft_items(id) | NFT藏品ID |
| transaction_hash | VARCHAR(66) | UNIQUE, NOT NULL | 交易哈希 |
| transaction_type | VARCHAR(50) | NOT NULL | 交易类型（mint, transfer, sale, auction等） |
| from_address | VARCHAR(42) | | 发送方地址 |
| to_address | VARCHAR(42) | | 接收方地址 |
| from_user_id | BIGINT | FOREIGN KEY REFERENCES users(id) | 发送方用户ID |
| to_user_id | BIGINT | FOREIGN KEY REFERENCES users(id) | 接收方用户ID |
| price | DECIMAL(20,8) | | 交易价格 |
| currency | VARCHAR(10) | | 货币类型（ETH, MATIC等） |
| gas_fee | DECIMAL(20,8) | | Gas费用 |
| royalty_fee | DECIMAL(20,8) | | 版税费用 |
| platform_fee | DECIMAL(20,8) | | 平台费用 |
| block_number | BIGINT | | 区块号 |
| block_timestamp | TIMESTAMP | | 区块时间戳 |
| status | VARCHAR(20) | DEFAULT 'pending' | 交易状态（pending, confirmed, failed） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### 2.4.2 市场挂单表 (market_listings)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 挂单唯一标识 |
| nft_item_id | BIGINT | FOREIGN KEY REFERENCES nft_items(id) | NFT藏品ID |
| seller_id | BIGINT | FOREIGN KEY REFERENCES users(id) | 卖家ID |
| listing_type | VARCHAR(20) | NOT NULL | 挂单类型（fixed_price, auction） |
| price | DECIMAL(20,8) | NOT NULL | 价格 |
| currency | VARCHAR(10) | NOT NULL | 货币类型 |
| start_time | TIMESTAMP | | 开始时间 |
| end_time | TIMESTAMP | | 结束时间 |
| status | VARCHAR(20) | DEFAULT 'active' | 状态（active, sold, cancelled, expired） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 2.4.3 竞价记录表 (bids)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 竞价唯一标识 |
| listing_id | BIGINT | FOREIGN KEY REFERENCES market_listings(id) | 挂单ID |
| bidder_id | BIGINT | FOREIGN KEY REFERENCES users(id) | 竞价者ID |
| bid_amount | DECIMAL(20,8) | NOT NULL | 竞价金额 |
| currency | VARCHAR(10) | NOT NULL | 货币类型 |
| status | VARCHAR(20) | DEFAULT 'active' | 状态（active, accepted, rejected, withdrawn） |
| expires_at | TIMESTAMP | | 过期时间 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 2.5 虚拟博物馆相关表

#### 2.5.1 虚拟博物馆表 (virtual_museums)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 博物馆唯一标识 |
| owner_id | BIGINT | FOREIGN KEY REFERENCES users(id) | 拥有者ID |
| name | VARCHAR(200) | NOT NULL | 博物馆名称 |
| description | TEXT | | 博物馆描述 |
| theme | VARCHAR(100) | | 主题 |
| layout_template | VARCHAR(100) | | 布局模板 |
| background_image | TEXT | | 背景图片URL |
| background_music | TEXT | | 背景音乐URL |
| is_public | BOOLEAN | DEFAULT TRUE | 是否公开 |
| visit_count | INT | DEFAULT 0 | 访问次数 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 2.5.2 博物馆展品表 (museum_exhibits)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 展品唯一标识 |
| museum_id | BIGINT | FOREIGN KEY REFERENCES virtual_museums(id) | 博物馆ID |
| nft_item_id | BIGINT | FOREIGN KEY REFERENCES nft_items(id) | NFT藏品ID |
| position_x | DECIMAL(10,4) | | X坐标 |
| position_y | DECIMAL(10,4) | | Y坐标 |
| position_z | DECIMAL(10,4) | | Z坐标 |
| rotation_x | DECIMAL(10,4) | DEFAULT 0 | X轴旋转 |
| rotation_y | DECIMAL(10,4) | DEFAULT 0 | Y轴旋转 |
| rotation_z | DECIMAL(10,4) | DEFAULT 0 | Z轴旋转 |
| scale | DECIMAL(10,4) | DEFAULT 1.0 | 缩放比例 |
| display_name | VARCHAR(200) | | 展示名称 |
| display_description | TEXT | | 展示描述 |
| sort_order | INT | DEFAULT 0 | 排序顺序 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### 2.5.3 博物馆装饰表 (museum_decorations)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 装饰唯一标识 |
| museum_id | BIGINT | FOREIGN KEY REFERENCES virtual_museums(id) | 博物馆ID |
| decoration_type | VARCHAR(50) | NOT NULL | 装饰类型（furniture, lighting, plant等） |
| model_url | TEXT | NOT NULL | 3D模型URL |
| position_x | DECIMAL(10,4) | | X坐标 |
| position_y | DECIMAL(10,4) | | Y坐标 |
| position_z | DECIMAL(10,4) | | Z坐标 |
| rotation_x | DECIMAL(10,4) | DEFAULT 0 | X轴旋转 |
| rotation_y | DECIMAL(10,4) | DEFAULT 0 | Y轴旋转 |
| rotation_z | DECIMAL(10,4) | DEFAULT 0 | Z轴旋转 |
| scale | DECIMAL(10,4) | DEFAULT 1.0 | 缩放比例 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 2.6 系统管理相关表

#### 2.6.1 系统配置表 (system_configs)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 配置唯一标识 |
| config_key | VARCHAR(100) | UNIQUE, NOT NULL | 配置键 |
| config_value | TEXT | | 配置值 |
| description | TEXT | | 配置描述 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 2.6.2 操作日志表 (operation_logs)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 日志唯一标识 |
| user_id | BIGINT | FOREIGN KEY REFERENCES users(id) | 用户ID |
| operation_type | VARCHAR(50) | NOT NULL | 操作类型 |
| resource_type | VARCHAR(50) | | 资源类型 |
| resource_id | BIGINT | | 资源ID |
| description | TEXT | | 操作描述 |
| ip_address | VARCHAR(45) | | IP地址 |
| user_agent | TEXT | | 用户代理 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

## 3. 索引设计

为了优化查询性能，需要为关键字段创建索引：

### 3.1 主要索引

*   **用户表索引**：
    *   `idx_users_username` ON users(username)
    *   `idx_users_email` ON users(email)
    *   `idx_users_wallet_address` ON users(wallet_address)

*   **NFT相关索引**：
    *   `idx_nft_items_collection_id` ON nft_items(collection_id)
    *   `idx_nft_items_creator_id` ON nft_items(creator_id)
    *   `idx_nft_items_current_owner_id` ON nft_items(current_owner_id)
    *   `idx_nft_items_token_id` ON nft_items(token_id)
    *   `idx_nft_attributes_nft_item_id` ON nft_attributes(nft_item_id)
    *   `idx_nft_attributes_trait_type` ON nft_attributes(trait_type)

*   **交易相关索引**：
    *   `idx_transactions_nft_item_id` ON transactions(nft_item_id)
    *   `idx_transactions_transaction_hash` ON transactions(transaction_hash)
    *   `idx_transactions_from_user_id` ON transactions(from_user_id)
    *   `idx_transactions_to_user_id` ON transactions(to_user_id)
    *   `idx_market_listings_nft_item_id` ON market_listings(nft_item_id)
    *   `idx_market_listings_seller_id` ON market_listings(seller_id)
    *   `idx_market_listings_status` ON market_listings(status)

*   **虚拟博物馆相关索引**：
    *   `idx_virtual_museums_owner_id` ON virtual_museums(owner_id)
    *   `idx_museum_exhibits_museum_id` ON museum_exhibits(museum_id)
    *   `idx_museum_exhibits_nft_item_id` ON museum_exhibits(nft_item_id)

### 3.2 复合索引

*   `idx_nft_items_collection_owner` ON nft_items(collection_id, current_owner_id)
*   `idx_transactions_user_type` ON transactions(from_user_id, transaction_type)
*   `idx_market_listings_status_price` ON market_listings(status, price)

## 4. 数据库优化策略

### 4.1 分区策略

对于大数据量的表，考虑使用分区来提高查询性能：

*   **交易记录表分区**：按照创建时间进行月度分区
*   **操作日志表分区**：按照创建时间进行月度分区

### 4.2 缓存策略

*   **热点数据缓存**：将频繁查询的NFT信息、用户信息等存储在Redis中
*   **查询结果缓存**：对复杂的统计查询结果进行缓存
*   **页面缓存**：对静态页面内容进行缓存

### 4.3 读写分离

*   **主从复制**：配置MySQL主从复制，读操作分发到从库
*   **连接池管理**：使用连接池管理数据库连接，提高并发性能

## 5. 数据安全与备份

### 5.1 数据加密

*   **敏感数据加密**：对用户密码、私钥等敏感信息进行加密存储
*   **传输加密**：使用SSL/TLS加密数据传输

### 5.2 备份策略

*   **定期备份**：每日进行全量备份，每小时进行增量备份
*   **异地备份**：将备份数据存储在不同地理位置的服务器上
*   **备份验证**：定期验证备份数据的完整性和可恢复性

### 5.3 访问控制

*   **权限管理**：实施最小权限原则，为不同角色分配相应的数据库访问权限
*   **审计日志**：记录所有数据库操作，便于安全审计

这份数据库设计文档为数字文物NFT平台提供了完整的数据存储方案，支持平台的各项核心功能，并考虑了性能优化、安全性和可扩展性等重要因素。

